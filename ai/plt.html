<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>رسم نمودار پیش‌بینی از فایل JSON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    body{font-family: system-ui, sans-serif; margin:16px;}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    #chartWrap{max-width:1200px;}
    label{white-space:nowrap;}
  </style>
</head>
<body>
  <h2>نمایش داده‌های پیش‌بینی - بارگذاری محلی</h2>

  <div class="row">
    <label>انتخاب فایل JSON پیش‌بینی:</label>
    <input type="file" id="fileInput" accept="application/json" />
  </div>

  <div id="chartWrap">
    <canvas id="chart" height="120"></canvas>
  </div>

  <p id="stats" style="margin-top:8px; font-weight:600;">لطفاً یک فایل JSON را جهت رسم نمودار انتخاب کنید.</p>

  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    let chart;

    // --- تابع محاسبه معیارهای ارزیابی (MAE و RMSE) ---
    function computeMetrics(actual, predicted) {
      const n = Math.min(actual.length, predicted.length);
      let absSum = 0, sqSum = 0, count = 0;
      for (let i = 0; i < n; i++) {
        const a = Number(actual[i]), p = Number(predicted[i]);
        if (Number.isFinite(a) && Number.isFinite(p)) {
          const diff = a - p;
          absSum += Math.abs(diff);
          sqSum  += diff * diff;
          count++;
        }
      }
      const mae = count ? absSum / count : NaN;
      const rmse = count ? Math.sqrt(sqSum / count) : NaN;
      return { mae, rmse, n: count };
    }

    // --- تابع اصلی رسم نمودار ---
    function drawChart(cfg) {
      // ساختار مورد انتظار: { actual_values: [...], predicted_values: [...], future_predictions: [...] }
      const actual = cfg.actual_values || [];
      const predicted = cfg.predicted_values || [];
      const future = cfg.future_predictions || [];

      if (actual.length === 0) {
        document.getElementById('stats').textContent = 'داده‌های "actual_values" در فایل JSON یافت نشد.';
        if (chart) chart.destroy();
        return;
      }
      
      const historicalLength = predicted.length; // طول داده‌های پیش‌بینی شده تاریخی
      const totalLength = historicalLength + future.length;
      const labels = Array.from({length: totalLength}, (_, i) => i);

      // منطق خط سبز پیش‌بینی آینده: با Null شروع می‌شود تا خطی پیوسته نباشد.
      const futureDataWithNulls = new Array(historicalLength - 1).fill(null).concat([
        predicted[historicalLength - 1], // آخرین نقطه پیش‌بینی تاریخی (نقطه اتصال)
        ...future                      // مقادیر آینده
      ]);

      const ds = [
        { 
          label: 'مقادیر واقعی (Actual)',     
          data: actual,    
          borderColor: '#1f77b4', 
          borderWidth: 2, 
          pointRadius: 0 // خط آبی
        },
        { 
          label: 'مقادیر پیش‌بینی‌شده (Predicted)', 
          data: predicted, 
          borderColor: '#ff7f0e', 
          borderWidth: 2, 
          pointRadius: 0 // خط نارنجی
        },
        { 
          label: 'پیش‌بینی آینده (Future)',     
          data: futureDataWithNulls,    
          borderColor: '#2ca02c', // رنگ سبز
          borderDash: [6, 6],    // خط چین
          
          // 💥 تغییرات برای کوچک شدن خط سبز
          borderWidth: 2,        // ضخامت نرمال
          pointRadius: (context) => {
            // نقطه را فقط در اولین نقطه (نقطه اتصال) بزرگتر رسم کن
            const index = context.dataIndex;
            return index === historicalLength - 1 ? 3 : 0; 
          },        
          pointBackgroundColor: '#2ca02c'
        }
      ];

      const { mae, rmse, n } = computeMetrics(actual.slice(0, predicted.length), predicted);
      const title = `Actual vs Predicted (n=${n}) — MAE=${mae?.toFixed(3)}  RMSE=${rmse?.toFixed(3)}`;
      document.getElementById('stats').textContent =
        `MAE = ${mae?.toFixed(4)} , RMSE = ${rmse?.toFixed(4)} (روی ${n} نقطهٔ معتبر)`;

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: ds },
        options: {
          responsive: true,
          interaction: { mode: 'nearest', intersect: false },
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: title }
          },
          scales: {
            x: { title: { display: true, text: 'اندیس داده‌ها' } },
            y: { title: { display: true, text: 'مقدار' }, ticks: { beginAtZero: false } }
          },
          elements: { line: { tension: 0 } } // بدون خمیدگی
        }
      });
    }

    // --- منطق بارگذاری فایل ---
    function loadFromFile(file) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const json = JSON.parse(e.target.result);
          drawChart(json);
        } catch (err) {
          alert('فرمت JSON نامعتبر است.');
          document.getElementById('stats').textContent = 'خطا: فرمت JSON نامعتبر است.';
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    // --- رویداد (Event) برای انتخاب فایل ---
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) loadFromFile(f);
    });
  </script>
</body>
</html>