<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>چت + نمودار</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      background: linear-gradient(
        135deg,
        rgba(18, 62, 255, 0.736) 0%, 
        rgba(133, 33, 255, 0.788) 100% 
    );
      background-size: 600%;
      animation: colorChange 15s ease infinite;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 2rem;
    }
    .glass {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }
    #messageInput {
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #ccc;
    }
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>

<header class="glass w-full max-w-3xl shadow-md p-4 mb-4">
  <h1 class="text-2xl font-bold text-center text-black">چت + نمودار</h1>
</header>

<div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 w-full max-w-3xl glass mb-4" style="height: 400px;"></div>

<div class="glass flex w-full max-w-3xl mb-2 p-2 rounded-xl shadow-lg items-center space-x-2 bg-white/20 backdrop-blur-md border border-white/30">
  <input id="messageInput" type="text" placeholder="پیام خود را بنویسید..."
    class="flex-1 px-4 py-2 rounded-lg bg-white/30 text-gray-900 placeholder-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:bg-white/50 transition duration-300 ease-in-out"/>
  <button id="sendBtn"
    class="px-5 py-2 rounded-lg bg-indigo-600 text-white font-semibold shadow-md hover:bg-indigo-700 hover:scale-105 transition duration-200 ease-in-out active:scale-95">
    ارسال
  </button>
</div>

<div class="glass p-4 w-full max-w-3xl mb-8">
  <div class="flex justify-center">
    <input type="file" id="fileUpload" accept=".csv,.xlsx,.xls" class="hidden">
    <label for="fileUpload" class="bg-indigo-600 text-white px-4 py-2 rounded-md cursor-pointer hover:bg-indigo-700">
      آپلود فایل (CSV/Excel)
    </label>
  </div>
  <div id="errorMessage" class="text-red-600 text-sm mt-2 hidden"></div>
  <div id="loading" class="text-gray-800 text-sm mt-2 hidden">در حال بارگذاری...</div>
</div>

<script>
const chatContainer = document.getElementById('chatContainer');
const fileUpload = document.getElementById('fileUpload');
const errorMessage = document.getElementById('errorMessage');
const loading = document.getElementById('loading');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');

let roomId = null;
const API_BASE = "http://127.0.0.1:8000/api";
const token = localStorage.getItem('access');


function showError(msg) {
  errorMessage.textContent = msg;
  errorMessage.classList.remove('hidden');
  setTimeout(() => errorMessage.classList.add('hidden'), 5000);
}


function toggleLoading(show) {
  loading.classList[show ? 'remove' : 'add']('hidden');
}


function addMessage(content, isUser = false) {
  const div = document.createElement('div');
  div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
  div.innerHTML = `
    <div class="max-w-full lg:max-w-2xl px-4 py-3 rounded-xl
      ${isUser ? 'bg-indigo-600 text-white self-end' : 'bg-gray-200 text-gray-900 glass'}">
      ${content}
    </div>`;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
  return div.querySelector('div');
}


async function initRoom() {
  toggleLoading(true);
  try {
    const res = await fetch(`${API_BASE}/chat/rooms/`, { headers: { 'Authorization': `Bearer ${token}` } });
    const rooms = await res.json();
    if (rooms.length > 0) {
      roomId = rooms[0].user_room_id;
      addMessage(`اتاق شما: ${rooms[0].name}`);
    } else {
      const createRes = await fetch(`${API_BASE}/chat/rooms/create/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ name: "چت جدید" })
      });
      const newRoom = await createRes.json();
      roomId = newRoom.user_room_id;
      addMessage(`اتاق جدید ساخته شد: ${newRoom.name}`);
    }
  } catch (e) {
    console.error(e);
    showError("خطا در بارگذاری روم‌ها");
  }
  toggleLoading(false);
}


async function loadHistory() {
  if (!roomId) return;
  try {
    const res = await fetch(`${API_BASE}/chat/rooms/${roomId}/messages/`, { headers: { 'Authorization': `Bearer ${token}` } });
    const data = await res.json();
    data.timeline.forEach(item => {
      if (item.type === 'message') addMessage(`${item.user_message}: ${item.ai_response || ''}`, item.user_message !== undefined);
      if (item.type === 'file') addMessage(`فایل: ${item.file}`);
    });
  } catch (e) {
    console.error(e);
  }
}


async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text || !roomId) return;
  addMessage(text, true);
  messageInput.value = '';
  toggleLoading(true);
  try {
    const res = await fetch(`${API_BASE}/chat/rooms/${roomId}/messages/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ user_message: text })
    });
    const data = await res.json();
    toggleLoading(false);
    if (res.ok) addMessage(`${data.ai_response}`);
    else showError(data.error || 'خطا در ارسال پیام');
  } catch (e) {
    toggleLoading(false);
    showError('خطا در ارتباط با سرور');
    console.error(e);
  }
}


function drawChartInChat(predictionData) {
  const container = addMessage(`<div class="chart-wrapper"><canvas></canvas></div>`);
  const canvas = container.querySelector('canvas');
  const ctx = canvas.getContext('2d');

 
  canvas.width = 900;
  canvas.height = 450;

  const actual = predictionData.actual_values || [];
  const predicted = predictionData.predicted_values || [];
  const future = predictionData.future_predictions || [];

  const historicalLength = predicted.length;
  const totalLength = historicalLength + future.length;
  const labels = Array.from({ length: totalLength }, (_, i) => i + 1);

  
  const futureDataWithNulls = new Array(historicalLength - 1).fill(null).concat([
    predicted[historicalLength - 1],
    ...future
  ]);

  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'واقعی',
          data: actual,
          borderColor: 'rgba(75,192,192,1)',
          borderWidth: 3,
          tension: 0.35,
          fill: false,
          pointRadius: 4,
          pointHoverRadius: 7,
          pointBackgroundColor: '#fff',
          pointBorderColor: 'rgba(75,192,192,1)',
        },
        {
          label: 'پیش‌بینی‌شده',
          data: predicted,
          borderColor: 'rgba(255,99,132,1)',
          borderWidth: 3,
          tension: 0.35,
          fill: false,
          pointRadius: 4,
          pointHoverRadius: 7,
          pointBackgroundColor: '#fff',
          pointBorderColor: 'rgba(255,99,132,1)',
        },
        {
          label: 'پیش‌بینی آینده',
          data: futureDataWithNulls,
          borderColor: 'rgba(255,206,86,1)',
          borderWidth: 3,
          borderDash: [6, 6],
          tension: 0.35,
          fill: false,
          pointRadius: 4,
          pointHoverRadius: 7,
          pointBackgroundColor: '#fff',
          pointBorderColor: 'rgba(255,206,86,1)',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'nearest', intersect: true },
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#000', font: { size: 13, weight: 'bold' } }
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(0,0,0,0.85)',
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 },
          padding: 10,
          displayColors: true,
          callbacks: {
            title: ctx => `اندیس: ${ctx[0].label}`,
            label: ctx => `${ctx.dataset.label}: ${ctx.formattedValue}`
          }
        },
        title: {
          display: true,
          text: 'نمودار خطی پیش‌بینی داده‌ها',
          color: '#000',
          font: { size: 18, weight: 'bold' }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'اندیس داده‌ها', color: '#333' },
          ticks: { color: '#333' },
          grid: { color: 'rgba(0,0,0,0.05)' }
        },
        y: {
          title: { display: true, text: 'مقدار', color: '#333' },
          ticks: { color: '#333' },
          grid: { color: 'rgba(0,0,0,0.05)' }
        }
      },
      animation: { duration: 1500, easing: 'easeInOutQuart' },
      hover: { mode: 'nearest', intersect: true }
    }
  });
}


fileUpload.addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file || !roomId) return;
  addMessage(`آپلود فایل: ${file.name}`, true);
  const formData = new FormData();
  formData.append('file', file);
  toggleLoading(true);
  try {
    const res = await fetch(`${API_BASE}/chat/rooms/${roomId}/upload/`, {
      method: 'POST',
      body: formData,
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    toggleLoading(false);
    if (data.success) {
      addMessage(`فایل "${file.name}" آپلود شد ✅`);
      if (data.analysis_result.prediction_data) {
        drawChartInChat(data.analysis_result.prediction_data);
      } else {
        addMessage(`تحلیلی یافت نشد.`);
      }
    } else {
      showError(data.error || 'خطا در پردازش فایل');
    }
  } catch (e) {
    toggleLoading(false);
    showError('خطا در ارتباط با سرور');
    console.error(e);
  }
});


sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });


window.addEventListener('DOMContentLoaded', async () => {
  await initRoom();
  await loadHistory();
  addMessage('سلام! فایل CSV یا Excel آپلود کنید تا نمودارش رو ببینید 📊');
});
</script>


</body>
</html>
